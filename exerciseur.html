<!DOCTYPE HTML>
<html lang="fr">
<head>
  <title id="titreHTML"></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.js"></script>
  <script src="./cookies.js"></script>
</head>
<body>
<div class="container">
<ul class="nav nav-tabs" id="myTab">
  <li ><a href="#questions" id="titreQuestions">Questions</a></li>
  <li><a href="#solution" id="titreSolutions">Solutions</a></li>
  <li><a class="active" href="#parametre" id="titreParemetres">Paramètres</a></li>
  <li><a href="#apropos" id="titreApropos">À propos</a></li>
</ul>
<div class="container">
<div class="jumbotron">
<h1 id="titrePage"> Exerciseur </h1>
</div>

<div class="tab-content">
    <div id="questions" class="tab-pane fade">
      <h3>Questions</h3>
      <p id="pageQuestion"></p>    
    </div>
    <div id="solution" class="tab-pane fade">
      <h3>Solution</h3>
        <p id="pageReponse"></p>
    </div>
    <div id="apropos" class="tab-pane fade">
    <h3>À propos</h3>
        <p id="pageAPropos">Générateur de questions arithmétiques</p>
        <ul>
        <li>Additions</li>
        <li>Multiplications</li>
        <li>Ne génère que des questions uniques</li>
        <li>S'imprime bien à 60% de la taille</li>
        </ul>
        <p >Petit projet personnel pour éviter de faire des exercices pour mes enfants et apprendre (un peu) le javascript</p>
        <p> (c) 2015 Benoît des Ligneris</p>
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Contrat Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">exerciseur</span> by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Benoît des Ligneris</span> est mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">licence Creative Commons Paternité 4.0 International</a>.
    </div>
    <div id="parametre" class="tab-pane fade in active">
      <h3>Paramètres</h3>
      <div class="container">
<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="prenom">Quel est votre prénom ?</label>  
  <div class="col-md-6">
  <input id="prenom" name="prenom" type="text" class="form-control input-md">
  <span class="help-block">Indiquez votre prénom pour une feuille personnalisée ?</span>  
  </div>
</div>

<!-- Select Basic -->
<div class="form-group">
  <label class="col-md-6 control-label" for="selectbasic">Opération</label>
  <div class="col-md-6">
    <select id="operation" name="operation" class="form-control">
      <option value="Addition">Addition</option>
      <option value="Multiplication">Multiplication</option>
    </select>
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="nbOperations">Combien d'exercices à produire ?</label>  
  <div class="col-md-6">
  <input id="nbOperations" name="nbOperations" type="text" value="20" class="form-control bfh-number" data-min="1" data-wrap="true">
  <span class="help-block">Combien d'opérations seront générées ?</span>  
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="minNumberForXY">Nombre minimal pour les X et Y</label>  
  <div class="col-md-6">
  <input id="minNumberForXY" name="minNumberForXY" type="text" value="1" class="form-control bfh-number" data-min="0">
  <span class="help-block">Nombre minimal pour les X et les Y</span>  
  </div>
</div>


<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="maxNumberForX">Nombre maximal pour les X</label>  
  <div class="col-md-6">
  <input id="maxNumberForX" name="max" type="text" value="12" class="form-control  bfh-number" data-min="0">
  <span class="help-block">Jusqu'à quel nombre aller pour les X(12 par défaut)</span>  
  </div>
</div>


<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="maxNumberForY">Nombre maximal pour les Y</label>  
  <div class="col-md-6">
  <input id="maxNumberForY" name="max" type="text" value="12" class="form-control  bfh-number" data-min="0">
  <span class="help-block">Jusqu'à quel nombre aller pour les Y(12 par défaut)</span>  
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-md-6 control-label" for="exclus">Liste de nombre à exclureQuels nombres exclure ?</label>  
  <div class="col-md-6">
  <input id="exclus" name="exclus" type="text" value="2,10" class="form-control input-md">
  <span class="help-block">Les nombres "trop faciles" à exclure (2 et 10 par défaut)</span>  
  </div>
</div>

<!-- Button -->
<div class="form-group">
  <label class="col-md-6 control-label" for="Soummettre">Lancer la génération</label>
  <div class="col-md-6">
    <button id="Soummettre" name="Soummettre" class="btn btn-primary">Démarrer</button>
  </div>
</div>
</div>
        <p id="pageParametre"></p>
    </div>
  </div>
</div>
  
</div>
</div>
</body>
</html>

<script type="text/javascript">

  // Définion des variables par défaut
  // Prénom
  prenom="NOT SET";


  // number of question per line (fixed in order to have a nice display using 4 column bootstrap)
  var numberOfQuestionPerLine = 4;

  // Minimal number for the generated numbers (X & Y)
  var minNumberForXY = 0 ;
  // Maximal number for the questions (X)
  var maxNumberForX =23;
  // Maximal number for the questions (Y)
  var maxNumberForY =23;
  // Number of question to ask
  var numberOfQuestion = 0;
  // numbers to exclude from one side of the questions
  var exclude =  [2, 10] ;
  

  // If we have already used the application, we have some cookies available ;-)
  // Let's use them and populate the default values of our variables
  // And of the forms
  
  prenom = docCookies.getItem("prenom","/");
  document.getElementById("prenom").value = prenom;

  // Show the active tab (Paremeters)
$(document).ready(function(){
    $(".nav-tabs a").click(function(){
        $(this).tab('show');
    });
});

  // operation : choix parmis Addition, Multiplication
  // TODO : soustraction et division
  // Soustraction : contrainte en plus, x doit être plus grand que y (option)
  // Division : contrainte en plus, x/y doit être un entier (option)
  //var operation="Multiplication";
  var operation="NOT SET";
  //var operation="Addition";
  var pageQuestion; 
  var pageReponse; 
  var pageParametre; 
 

// Assigne les valeurs du formulaire aux variables
// Quand on clique, donne le focus à l'onglet des questions
$('#Soummettre').on('click', function (e) {

  pageQuestion="<div class=\"container\">"; 
  pageReponse="<div class=\"container\">"; 
  pageParametre="<div class=\"container\">"; 


    // Assign form values from the form to the variables
    prenom=document.getElementById("prenom").value;
    // Conserve the lastname in a cookie
    docCookies.setItem("prenom",prenom,31536e3,"/");
    operation=document.getElementById("operation").value;
    numberOfQuestion=parseInt(document.getElementById("nbOperations").value);
    maxNumberForX=parseInt(document.getElementById("maxNumberForX").value);
    maxNumberForY=parseInt(document.getElementById("maxNumberForY").value);
    minNumberForXY=parseInt(document.getElementById("minNumberForXY").value);
    exclude=document.getElementById("exclus").value.split(",");
    // Convert all the strings to integers
    for (index =0;index<exclude.length;index++ ){
      exclude[index] = parseInt(exclude[index]);  
    }
    pageParametre+=prenom;
    document.getElementById("titrePage").innerHTML = operation +" pour "+ prenom;
    document.getElementById("titreHTML").innerHTML = operation +" pour "+ prenom;
    
    possibilityForX = maxNumberForX - minNumberForXY - exclude.length + 1;
    possibilityForY = maxNumberForY - minNumberForXY - exclude.length + 1;
    //  If maxNumbers*maxNumbers<numberOfQuestion : ABORT ! IMPOSSIBLE !
    if (possibilityForX*possibilityForY < numberOfQuestion){
    alert('Impossible de générer autant d\'exercices avec les limites choisies ! Augmentez le nombre d\'exercices');
    // pageQuestion+="<div class=\"alert alert-danger fade in\">";
    // pageQuestion+="<a href=\"#\" class=\"close\" data-dismiss=\"alert\">&times;</a>";
    // pageQuestion+="<strong>Erreur!</strong> Impossible de générer autant d'exercices avec les limites choisies !";
    // pageQuestion+="<\/div>";
   
    // Same message on the Question page (ERROR MESSAGE) 

    //pageReponse=pageQuestion;
     throw new Error('Impossible de générer autant de questions');
  }
  else
  {
    buildQuestionAndAnswerPage();
    //  TODO : DISPLAY QUESTION TAB
    //$('#questions').focus();
    // Display the "Question" tab instead of the parameter one when the button is clicked
    document.getElementById("pageQuestion").innerHTML = pageQuestion;
    document.getElementById("pageReponse").innerHTML = pageReponse;
    $('#myTab a[href="#questions"]').tab('show');
    //$(this).find("#questions").focus();
    //alert("Hello prenom="+prenom+", operation="+operation+" numberOfQuestion="+numberOfQuestion+" max="+max+"exclude= "+exclude);

  }
});

  function buildParameterPage(){
    
  }
  function checkExclusion(number,exclusions){
    ex=0;
    for (index=0;index<exclusions.length;index++){
      if (number == exclusions[index]) ex=1;
    }
    return ex;
  }

  function randomInteger(iMin,iMax){
    iMin=parseInt(iMin);
    iMax=parseInt(iMax);
  	randomInt=Math.random();
  	randomInt=randomInt*(iMax-iMin);
    randomInt=Math.ceil(randomInt);
  	return randomInt;
  }

  function randomIntegerWithExclusion(iMin,iMax,exclusions){
    iMin=parseInt(iMin);
    iMax=parseInt(iMax);
    var number =randomInteger(iMin,iMax);
    while (checkExclusion(number,exclusions) == 1) number=randomInteger(iMin,iMax);
    return number;
  }

  function buildQuestionAndAnswerPage(){
    //Initialise for the first round
      var x = 0;
      var y = 0;
    //Initialize the array of questions : cela va forcer un nouveau tirage
      var questionArray = ["0et0"];
      var retryArray = [];
    // Compute the number of lines
    var nbLignes=numberOfQuestion / numberOfQuestionPerLine;

    // Main loop : rows
  	for (var i=0;i<nbLignes;i++){
      // String to display based on the operation selected
      var stringToAdd="";
      // Computed result to display on the result page
      var computedResult=0;

  		pageQuestion+="<div class=\"row\">";
  		pageReponse+="<div class=\"row\">";

      // Secondary loop : columns
    	for (var j=0;j<numberOfQuestionPerLine;j++){
        x = randomIntegerWithExclusion(minNumberForXY,maxNumberForX,exclude);
        y = randomIntegerWithExclusion(minNumberForXY,maxNumberForY,exclude); 
        // Search for (x,y) or (y,x) in the already ask question
        // If a match is found, generate another (x,y) until success
        // FIXME : Can cause infinite loop when number of questions > max number of questions
        var avoidInfinitLoop=0;
        while (questionArray.indexOf(x+"et"+y)>0 || questionArray.indexOf(y+"et"+x)>0){
          retryArray.push(x+"et"+y+" ou "+y+"et"+x);
          x = randomIntegerWithExclusion(minNumberForXY,maxNumberForX,exclude);
          y = randomIntegerWithExclusion(minNumberForXY,maxNumberForY,exclude); 
          avoidInfinitLoop++;
          if (avoidInfinitLoop>50) break;
        }

        // Add the new question to the question array
        questionArray.push(x+"et"+y);

        // Management of the various operations    
        switch (operation) {
          case "Addition":
            stringToAdd=x+'+'+y;
            computedResult=x+y;
            break;
          case "Multiplication":
            stringToAdd=x+"x"+y;
            computedResult=x*y;
            break;
        }
        // Generate the HTML to display the question & answer
  			pageQuestion += "<div class=\"col-sm-3\"><h3>"+stringToAdd+"= <mark>____</mark> </h3></div>";
  			pageReponse += "<div class=\"col-sm-3\"><h3>"  +stringToAdd+"= <mark>" + computedResult +"</mark></h3></div>";
  		}
      // Debug
      pageReponse+="</div>"+questionArray.toString();
      pageReponse+="</div>"+retryArray.toString();
      // Normal
  		pageReponse+="</div>";
  		pageQuestion+="</div>";
  	}
  	pageReponse += "</div>";
  	pageQuestion +="</div>";
}

</script>
  
</body>
</html>
